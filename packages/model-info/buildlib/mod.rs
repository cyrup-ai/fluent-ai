use anyhow::{Context, Result};
use std::fs;
use std::path::Path;
use termcolor::{info, success_check, colored_println};


pub mod providers;
pub mod codegen;

use providers::process_all_providers;

/// Main orchestrator for the modular build system
/// Coordinates all provider modules and generates the final output
pub fn generate_model_code() -> Result<()> {
    info!("Starting modular model code generation...");
    
    // Process all providers using strategy pattern with impl Trait
    let results = process_all_providers();
    
    // Check results and handle any failures
    for result in &results {
        if result.success {
            success_check!("{}", result.status);
        } else {
            return Err(anyhow::anyhow!("Provider failed: {}", result.status));
        }
    }
    
    let successful_count = results.iter().filter(|r| r.success).count();
    
    // Write generated code file
    let output_path = Path::new("src/generated_models.rs");
    let final_code = format!(
        "// Generated code - DO NOT EDIT MANUALLY\n// This file is automatically generated by build.rs\n// Successfully processed {} providers\n\n// Provider implementations will be added here by each provider's process() method\n",
        successful_count
    );
    
    fs::write(output_path, final_code)
        .context("Failed to write generated_models.rs")?;
    
    success_check!("Successfully generated src/generated_models.rs");
    colored_println!("Model code generation completed successfully!");
    
    Ok(())
}

